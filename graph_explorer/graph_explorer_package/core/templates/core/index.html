<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graph Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .app-container {
            display: grid;
            height: 100vh;
            grid-template-columns: 250px 1fr; 
            /* Header + Tabs + Main + BirdView */
            grid-template-rows: auto auto 1fr 200px 200px; 
            grid-template-areas: 
                "header header"
                "tabs tabs"
                "tree main"
                "bird main"
                "cli cli";
        }

        .header {
            grid-area: header;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
            padding: 10px;
        }

        .toolbar-form {
            display: grid;
            grid-template-columns: repeat(4, auto); /* 4 kolone, možeš menjati */
            grid-auto-rows: auto;
            column-gap: 20px;
            row-gap: 10px;
            align-items: center;
            width: 100%;
        }

        .workspace-tabs {
            grid-area: tabs;
            background-color: #e9ecef;
            border-bottom: 1px solid #ccc;
            display: flex;
            align-items: flex-end;
            padding-left: 10px;
            padding-top: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 5px;
        }

        .tab {
            background-color: #d1d8e0;
            padding: 3px 7px 4px 10px;
            border-radius: 8px 8px 0 0;
            border: 1px solid #ccc;
            border-bottom: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }

        .tab:hover {
            background-color: #ced4da;
        }

        .tab.active {
            background-color: #fff; /* Aktivni tab se stapa sa main view */
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #fff; /* Sakriva liniju ispod */
            margin-bottom: -1px; /* Preklapa border kontejnera */
            z-index: 5;
        }

        .tab-close {
            margin-top: 3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            font-size: 12px;
            color: #777;
        }
        .tab-close:hover {
            background-color: #ff6b6b;
            color: white;
        }
        /* --------------------------- */

        .tree-view {
            grid-area: tree;
            background-color: #fff;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        .main-view {
            grid-area: main;
            background-color: #fff; /* Promenjeno u belo da se slaze sa aktivnim tabom */
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #888;
        }

        .bird-view {
            grid-area: bird;
            background-color: #fff;
            border-right: 1px solid #ddd;
            border-top: 1px solid #ddd;
            padding: 10px;
        }

        .toolbar-form {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
            flex-wrap: wrap; 
        }

        .form-group { display: flex; align-items: center; gap: 5px; }
        label { font-weight: 600; font-size: 0.9rem; color: #333; }
        select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; min-width: 150px; }
        
        button.btn-load {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button.btn-load:hover { background-color: #218838; }

        .form-input {
            padding: 5px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
        }
        
        /* --- TREE VIEW STILOVI --- */
        .tree-ul { list-style-type: none; padding-left: 20px; margin: 0; }
        .tree-li { margin: 5px 0; white-space: nowrap; }
        .tree-toggle {
            cursor: pointer; display: inline-block; width: 15px; text-align: center;
            margin-right: 5px; font-weight: bold; color: #555;
            border: 1px solid #ccc; border-radius: 3px; background-color: #eee;
            line-height: 14px; font-size: 12px;
        }
        .tree-toggle:hover { background-color: #ddd; }
        .tree-label { cursor: pointer; font-size: 14px; }
        .tree-label:hover { color: #007bff; text-decoration: underline; }
        .tree-cycle { color: #e74c3c; font-style: italic; font-size: 0.9em; margin-left: 5px; }

        .messages {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: auto; max-width: 80%; padding: 0; list-style: none;
        }

        .messages li {
            padding: 15px 25px; margin-bottom: 10px; border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold;
            animation: fadeOut 3s forwards;
        }

        .applied-tags {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            z-index: 20;
        }

        .tag {
            background-color: #d1d8e0;
            color: #333;
            padding: 3px 7px 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }

        .tag:hover {
            background-color: #ced4da;
        }

        .tag span {
            margin-top: 3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            font-size: 12px;
            color: #777;
            background-color: transparent;
            border-color: transparent;
        }

        .tag span:hover {
            background-color: #ff6b6b;
            color: white;
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }

        h3.panel-title { margin: 0 0 10px 0; font-size: 0.85rem; text-transform: uppercase; color: #999; letter-spacing: 1px; }

        
        /* --- CLI PANEL --- */
        .cli-panel {
            grid-area: cli;
            background: #f5f5f5;
            color: #333;
            font-family: monospace;
            padding: 12px;
            display: none; /* hidden by default */
            height: 200px;
            overflow-y: auto;
            border-top: 2px solid #d0d0d0;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
        }

        .cli-input {
            width: 100%;
            background: #ffffff;
            border: 1px solid #ccc;
            color: #333;
            padding: 8px;
            font-family: monospace;
            border-radius: 6px;
            margin-top: 10px;
            box-shadow: 0 0 4px rgba(0,0,0,0.05);
        }



    </style>
</head>
<body>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
            <li style="{% if message.tags == 'success' %}background:#d4edda; color:#155724;{% endif %}
                       {% if message.tags == 'error' %}background:#f8d7da; color:#721c24;{% endif %}">
                {{ message }}
            </li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="app-container">
        
        <header class="header">

            

            <form method="post" class="toolbar-form">
                {% csrf_token %}

                <div class="form-group">
                    <label>View:</label>
                    <select name="visualizer" id="visualizer-select" onchange="changeVisualizer()">
                        <option value="" disabled>-- Select a visualizer --</option>    
                        {% for vis in visualizers %}
                            <option value="{{ vis }}" 
                                {% if vis == selected_visualizer %}selected
                                {% elif not selected_visualizer and forloop.first %}selected
                                {% endif %}>
                                {{ vis }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Source:</label>
                    <select name="plugin_name" id="plugin-select" onchange="updateFiles()">
                        <option value="" selected disabled>-- Select a source --</option>   
                            {% for plugin in plugins %}
                                <option value="{{ plugin }}">{{ plugin }}</option>
                            {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>File:</label>
                    <select name="source_path" id="file-select">
                        <option value="">-- Select a file --</option>
                    </select>
                </div>

                <button type="submit" class="btn-load">Load Graph (New Tab)</button>

                <div class="form-group">
                    <label>Search:</label>
                    <input id="searchQuery" type="text" placeholder="Search nodes..." class="form-input">
                    <button type="button" class="btn-load" onclick="searchGraph()">Search</button>
                </div>

                <div class="form-group">
                    <label>Filter:</label>
                    <input id="filterAttr" type="text" placeholder="attribute" class="form-input">
                    <select id="filterOp">
                        <option value=">">></option>
                        <option value="<"><</option>
                        <option value="==">==</option>
                        <option value="!=">!=</option>
                        <option value=">=">>=</option>
                        <option value="<="><=</option>
                    </select>
                    <input id="filterValue" type="text" placeholder="value" class="form-input">
                    <button type="button" class="btn-load" onclick="filterGraph()">Apply</button>
                </div>
            </form>
            <button type="button" id="cli-toggle-btn" style="border:none;cursor:pointer;">
                Open CLI
            </button>
        </header>

        <div class="workspace-tabs" id="tabs-container">
            <div style="padding: 10px; color: #888; font-size: 0.9em; font-style: italic;">No open workspaces</div>
        </div>

        <aside class="tree-view">
            <h3 class="panel-title">Tree View</h3>
            <div id="tree-content">
                <small>No graph loaded.</small>
            </div>
        </aside>

        <div class="bird-view">
            <h3 class="panel-title">Bird View</h3>
            <div id="bird-view-container" style="width: 100%; height: 100%; overflow: hidden; position: relative;"></div>
        </div>

        <main class="main-view" id="main-container">
            <div id="applied-tags" class="applied-tags">
                {% for search in applied_searches %}
                    <div class="tag">
                        Search: {{ search }}
                        <span onclick="removeTag('search', '{{ search }}')">&times</span>
                    </div>
                {% endfor %}

                {% for f in applied_filters %}
                    <div class="tag">
                        Filter: {{ f.attribute }} {{ f.operator }} {{ f.value }}
                        <span onclick="removeTag('filter', '{{ f.attribute }}|{{ f.operator }}|{{ f.value }}')">&times</span>
                    </div>
                {% endfor %}
            </div>
            <div id="main-content" style="width: 100%; height: 100%;">
                <div style="text-align: center; padding-top: 50px; color: #888;">
                    <h2>Main View Canvas</h2>
                    <p>Select a file and click Load Graph to create a Workspace</p>
                </div>
            </div>
        </main>
        

        <div class="cli-panel" id="cli-panel">
            <div id="cli-output">CLI ready.</div>
            <input type="text" id="cli-input" class="cli-input" placeholder="Enter command...">
        </div>

    </div>

    <script>

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        const filesMap = {{ files_map|safe }}; 
        // Django nam salje ID ako je tek kreiran graf
        const initialGraphId = "{{ graph_id|default:'' }}"; 

        // --- UPRAVLJANJE TABOVIMA (WORKSPACES) ---

        let currentActiveWorkspaceId = null;

        async function loadWorkspaces() {
            try {
                const resp = await fetch("/api/workspaces/");
                const data = await resp.json();
                renderTabs(data.workspaces);

                // Ako imamo inicijalni ID (od POST-a), setuj ga u JS promenljivu
                if (initialGraphId && !currentActiveWorkspaceId) {
                    currentActiveWorkspaceId = initialGraphId;
                    // Trigger load logic
                    loadVisualization(initialGraphId);
                    loadTreeView(initialGraphId);
                } else {
                    // Ako nemamo eksplicitno setovan, nadji onaj koji je active=true iz baze
                    const activeWs = data.workspaces.find(w => w.active);
                    if (activeWs) {
                        currentActiveWorkspaceId = activeWs.id;
                        loadVisualization(activeWs.id);
                        loadTreeView(activeWs.id);
                    }
                }

            } catch (e) {
                console.error("Error loading workspaces:", e);
            }
        }

        function renderTabs(workspaces) {
            const container = document.getElementById('tabs-container');
            const visSelect = document.getElementById('visualizer-select');
            container.innerHTML = ''; // Clear

            if (workspaces.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: #888; font-size: 0.9em; font-style: italic;">No open workspaces</div>';
                document.getElementById('main-content').innerHTML = '<p style="text-align:center; margin-top:50px; color:#999;">No active workspace.</p>';
                document.getElementById('tree-content').innerHTML = '<small>No graph loaded.</small>';
                return;
            }

            workspaces.forEach(ws => {
                const tab = document.createElement('div');
                // Provera da li je ovaj tab aktivan
                // (Server nam kaze koji je aktivan, ili koristimo lokalnu logiku)
                const isActive = (ws.id === currentActiveWorkspaceId) || ws.active;
                
                tab.className = `tab ${isActive ? 'active' : ''}`;

                if (isActive && ws.visualizer) {
                    visSelect.value = ws.visualizer;
                    renderAppliedTags();
                }
                
                // Klik na tab -> Switch
                tab.onclick = () => switchWorkspace(ws.id);

                // Ime taba
                const titleSpan = document.createElement('span');
                titleSpan.textContent = ws.name;
                tab.appendChild(titleSpan);

                // Close dugme (x)
                const closeBtn = document.createElement('span');
                closeBtn.className = 'tab-close';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = (e) => {
                    e.stopPropagation(); // Da ne triggeruje switch
                    deleteWorkspace(ws.id);
                };
                tab.appendChild(closeBtn);

                container.appendChild(tab);
            });
        }

        async function switchWorkspace(workspaceId) {
            // 1. Pozovi API da javis serveru
            try {
                const resp = await fetch(`/api/workspace/switch/${workspaceId}/`);
                if (!resp.ok) throw new Error("Switch failed");
                
                // 2. Azuriraj lokalno stanje
                currentActiveWorkspaceId = workspaceId;
                
                // 3. Osvezi listu tabova (da se prebaci 'active' klasa)
                // (Mogli bismo i samo JS-om da prebacimo klasu, ali ovo je sigurnije)
                const wsResp = await fetch("/api/workspaces/");
                const data = await wsResp.json();
                renderTabs(data.workspaces);

                // 4. Ucitaj sadržaj
                loadVisualization(workspaceId);
                loadTreeView(workspaceId);

            } catch (e) {
                console.error(e);
                alert("Failed to switch workspace.");
            }
        }

        async function deleteWorkspace(workspaceId) {
            try {
                const resp = await fetch(`/api/workspace/delete/${workspaceId}/`);
                if (!resp.ok) throw new Error("Delete failed");
                
                // Ako smo obrisali trenutni, resetuj ID
                if (workspaceId === currentActiveWorkspaceId) {
                    currentActiveWorkspaceId = null;
                }
                
                // Ponovo ucitaj sve (server ce odluciti ko je sledeci aktivan)
                loadWorkspaces();

            } catch (e) {
                console.error(e);
            }
        }


        // --- STARE FUNKCIJE (Prilagođene) ---

        function updateFiles() {
            const pluginSelect = document.getElementById('plugin-select');
            const fileSelect = document.getElementById('file-select');
            const selectedPlugin = pluginSelect.value;
            fileSelect.innerHTML = '<option value="">-- Select a file --</option>';
            if (!selectedPlugin) return;
            const files = filesMap[selectedPlugin] || [];
            files.forEach(file => {
                const option = document.createElement('option');
                option.value = file.path;
                option.text = file.name;
                fileSelect.add(option);
            });
        }

        async function fetchTags() {
            const response = await fetch("/api/tags/", {
                method: "GET",
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() }
            });
            return await response.json();
        }

        async function renderAppliedTags(tags) {
            if (!tags) {
                tags = await fetchTags();
            }

            const container = document.getElementById("applied-tags");
            container.innerHTML = "";

            const applied_searches = tags[0] || [];
            const applied_filters = tags[1] || [];

            applied_searches.forEach(search => {
                const tag = document.createElement("div");
                tag.className = "tag";
                tag.innerHTML = `Search: ${search} <span onclick="removeSearch('${search}')">&times</span>`;
                container.appendChild(tag);
            });

            applied_filters.forEach(f => {
                const tag = document.createElement("div");
                tag.className = "tag";
                tag.innerHTML = `Filter: ${f["attribute"]} ${f["operator"]} ${f["value"]} <span onclick="removeFilter('${f["attribute"]}|${f["operator"]}|${f["value"]}')">&times</span>`;
                container.appendChild(tag);
            });
        }

        async function searchGraph() {
            const query = document.getElementById("searchQuery").value;
            const resp = await fetch("/api/graph/search", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                body: JSON.stringify({ query })
            });

            if (!resp.ok) return;

            const data = await resp.json();
            renderAppliedTags(data);

            // Refresh current
            if (currentActiveWorkspaceId) {
                loadVisualization(currentActiveWorkspaceId);
                loadTreeView(currentActiveWorkspaceId);
            }
        }

        async function filterGraph() {
            const attr = document.getElementById("filterAttr").value;
            const op = document.getElementById("filterOp").value;
            const value = document.getElementById("filterValue").value;
            const resp = await fetch("/api/graph/filter", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                body: JSON.stringify({ attribute: attr, operator: op, value })
            });

            if (!resp.ok) return;

            const data = await resp.json();
            renderAppliedTags(data);

            if (currentActiveWorkspaceId) {
                loadVisualization(currentActiveWorkspaceId);
                loadTreeView(currentActiveWorkspaceId);
            }
        }

        function changeVisualizer() {
            if (currentActiveWorkspaceId) {
                loadVisualization(currentActiveWorkspaceId);
            }
        }

        async function loadVisualization(graphId) {
            if (!graphId) return;
            const visSelect = document.getElementById('visualizer-select');
            const selectedVis = visSelect.value;
            const mainContent = document.getElementById('main-content');
            
            // mainContent.innerHTML = '<p style="text-align:center; margin-top:20px;">Loading visualization...</p>';

            try {
                // Koristimo graphId (workspace UUID)
                const response = await fetch(`/api/visualize/${graphId}/?visualizer=${selectedVis}`);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                
                const htmlData = await response.text();
                mainContent.innerHTML = htmlData;

                // Execute scripts
                const scripts = mainContent.querySelectorAll("script");
                scripts.forEach(oldScript => {
                    const newScript = document.createElement("script");
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
            } catch (error) {
                console.error("Visualization error:", error);
                mainContent.innerHTML = `<p style="color:red; text-align:center;">Error loading visualization: ${error.message}</p>`;
            }
        }

        // --- TREE VIEW ---
        let graphDataCache = null;

        async function loadTreeView(graphId) {
            const treeContainer = document.getElementById('tree-content');
            // treeContainer.innerHTML = 'Loading tree...'; // Opciono da ne blinka

            try {
                const response = await fetch(`/api/graph_data/${graphId}/`);
                if (!response.ok) throw new Error("Failed to load tree data");
                
                graphDataCache = await response.json();
                
                treeContainer.innerHTML = '';
                const rootUl = document.createElement('ul');
                rootUl.className = 'tree-ul';
                rootUl.style.paddingLeft = '0px';
                treeContainer.appendChild(rootUl);

                const targets = new Set(graphDataCache.links.map(l => l.target));
                let roots = graphDataCache.nodes.filter(n => !targets.has(n.id));
                
                if (roots.length === 0 && graphDataCache.nodes.length > 0) {
                    roots = [graphDataCache.nodes[0]]; 
                }

                roots.forEach(node => {
                    renderTreeNode(rootUl, node, []);
                });

            } catch (error) {
                console.error(error);
                treeContainer.innerHTML = 'Error loading tree.';
            }
        }

        function renderTreeNode(parentElement, node, visitedPath) {
            const li = document.createElement('li');
            li.className = 'tree-li';
            
            const childrenLinks = graphDataCache.links.filter(l => l.source === node.id);
            const hasChildren = childrenLinks.length > 0;

            if (hasChildren) {
                const toggleBtn = document.createElement('span');
                toggleBtn.className = 'tree-toggle';
                toggleBtn.textContent = '+';
                toggleBtn.onclick = (e) => toggleNode(e, node, childrenLinks, visitedPath);
                li.appendChild(toggleBtn);
            } else {
                const spacer = document.createElement('span');
                spacer.style.display = 'inline-block';
                spacer.style.width = '22px'; 
                li.appendChild(spacer);
            }

            const labelSpan = document.createElement('span');
            labelSpan.className = 'tree-label';
            labelSpan.textContent = node.label;
            li.appendChild(labelSpan);

            if (hasChildren) {
                const childrenUl = document.createElement('ul');
                childrenUl.className = 'tree-ul';
                childrenUl.style.display = 'none';
                li.appendChild(childrenUl);
            }

            parentElement.appendChild(li);
        }

        function toggleNode(event, node, childrenLinks, visitedPath) {
            const btn = event.target;
            const li = btn.parentElement;
            const childrenUl = li.querySelector('ul');

            if (childrenUl.style.display === 'none') {
                childrenUl.style.display = 'block';
                btn.textContent = '-';

                if (childrenUl.children.length === 0) {
                    const newPath = [...visitedPath, node.id];
                    childrenLinks.forEach(link => {
                        const childNode = graphDataCache.nodes.find(n => n.id === link.target);
                        if (newPath.includes(childNode.id)) {
                            const cycleLi = document.createElement('li');
                            cycleLi.className = 'tree-li';
                            cycleLi.innerHTML = `<span style="margin-left:22px;">${childNode.label}</span> <span class="tree-cycle">(ciklus)</span>`;
                            childrenUl.appendChild(cycleLi);
                        } else {
                            renderTreeNode(childrenUl, childNode, newPath);
                        }
                    });
                }
            } else {
                childrenUl.style.display = 'none';
                btn.textContent = '+';
            }
        }

        async function removeSearch(searchValue) {
            await fetch("/api/remove-tag/", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                body: JSON.stringify({
                    type: "search",
                    value: searchValue
                })
            })
            .then(res => res.json())
            .then(data => {
                renderAppliedTags(data);  
                if (currentActiveWorkspaceId) {
                    loadVisualization(currentActiveWorkspaceId);
                    loadTreeView(currentActiveWorkspaceId);
                }       
            })
            .catch(err => console.error("Error removing search:", err));
        }

        async function removeFilter(filterString) { 
            await fetch("/api/remove-tag/", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                body: JSON.stringify({
                    type: "filter",
                    value: filterString
                })
            })
            .then(res => res.json())
            .then(data => {
                renderAppliedTags(data);
                if (currentActiveWorkspaceId) {
                    loadVisualization(currentActiveWorkspaceId);
                    loadTreeView(currentActiveWorkspaceId);
                }       
            })
            .catch(err => console.error("Error removing filter:", err));
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadWorkspaces();
        });

        // --- CLI TOGGLE ---
    document.getElementById("cli-toggle-btn").addEventListener("click", () => {
        const panel = document.getElementById("cli-panel");
        const btn = document.getElementById("cli-toggle-btn");

        if (panel.style.display === "none" || panel.style.display === "") {
            panel.style.display = "block";
            btn.textContent = "Close CLI";
        } else {
            panel.style.display = "none";
            btn.textContent = "Open CLI";
        }
    });

    // --- CLI INPUT LOGIC ---
    const cliInput = document.getElementById("cli-input");
    const cliOutput = document.getElementById("cli-output");

    cliInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
            const command = cliInput.value.trim();
            if (command === "") return;

            cliOutput.innerHTML += `<div>&gt; ${command}</div>`;
            cliInput.value = "";

            const query = command;
            
            try {
            // 2. Posalji na backend
            const resp = await fetch("/api/graph/cli", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "X-CSRFToken": getCSRFToken() 
                },
                body: JSON.stringify({ command: command })
            });

            const data = await resp.json();

            if (data.error) {
                
            } else {
                

                // Posto je komanda mozda promenila graf, moramo ponovo ucitati vizualizaciju
                if (currentActiveWorkspaceId) {
                    loadVisualization(currentActiveWorkspaceId);
                    loadTreeView(currentActiveWorkspaceId);
                }
            }
        } catch (err) {
            
        }
            cliOutput.innerHTML += `<div style="color:#888;">Executed.</div>`;
            cliOutput.scrollTop = cliOutput.scrollHeight;
        }
    });


    </script>
</body>
</html>