<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graph Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .app-container {
            display: grid;
            height: 100vh;
            grid-template-columns: 250px 1fr; 
            grid-template-rows: 60px 1fr 200px; 
            grid-template-areas: 
                "header header"
                "tree main"
                "bird main";
        }

        .header {
            grid-area: header;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .tree-view {
            grid-area: tree;
            background-color: #fff;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        .main-view {
            grid-area: main;
            background-color: #e9ecef; 
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #888;
        }

        .bird-view {
            grid-area: bird;
            background-color: #fff;
            border-right: 1px solid #ddd;
            border-top: 1px solid #ddd;
            padding: 10px;
        }

        .toolbar-form {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
        }

        .form-group { display: flex; align-items: center; gap: 5px; }
        label { font-weight: 600; font-size: 0.9rem; color: #333; }
        select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; min-width: 150px; }
        
        button.btn-load {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-left: auto;
        }
        button.btn-load:hover { background-color: #218838; }
        
        .messages {
        position: fixed;     
        top: 20px;        
        left: 50%;    
        transform: translateX(-50%);
        z-index: 1000;  
        width: auto;
        max-width: 80%;
        padding: 0;
        list-style: none;
    }

    .messages li {
        padding: 15px 25px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        font-weight: bold;
        animation: fadeOut 3s forwards;
    }

    @keyframes fadeOut {
        0% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; display: none; }
    }

        h3.panel-title { margin: 0 0 10px 0; font-size: 0.85rem; text-transform: uppercase; color: #999; letter-spacing: 1px; }

    </style>
</head>
<body>

    {% if messages %}
        <ul class="messages" style="list-style:none; padding:10px; margin-bottom:20px;">
            {% for message in messages %}
            <li style="padding:10px; border-radius:5px; 
                {% if message.tags == 'success' %}background:#d4edda; color:#155724;{% endif %}
                {% if message.tags == 'error' %}background:#f8d7da; color:#721c24;{% endif %}">
                {{ message }}
            </li>
            {% endfor %}
        </ul>
    {% endif %}
    <div class="app-container">
        
        <header class="header">
            <form method="post" class="toolbar-form">
                {% csrf_token %}

                <div class="form-group">
                    <label>View:</label>
                    <select name="visualizer" id="visualizer-select" onchange="changeVisualizer()">
                        <option value="" disabled>-- Select a visualizer --</option>    
                        {% for vis in visualizers %}
                            <option value="{{ vis }}" 
                                {% if vis == selected_visualizer %}selected
                                {% elif not selected_visualizer and forloop.first %}selected
                                {% endif %}>
                                {{ vis }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Source:</label>
                    <select name="plugin_name" id="plugin-select" onchange="updateFiles()">
                        <option value="" selected disabled>-- Select a source --</option>   
                            {% for plugin in plugins %}
                                <option value="{{ plugin }}">{{ plugin }}</option>
                            {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>File:</label>
                    <select name="source_path" id="file-select">
                        <option value="">-- Select a file --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Search:</label>
                    <input type="text" placeholder="Search nodes..." style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                </div>

                <button type="submit" class="btn-load">Load Graph</button>
            </form>
        </header>
        <aside class="tree-view">
            <h3 class="panel-title">Tree View</h3>
            <div id="tree-content">
                <small>No graph loaded.</small>
            </div>
        </aside>

        <div class="bird-view">
            <h3 class="panel-title">Bird View</h3>
        </div>

        <main class="main-view" id="main-container">
            <div id="main-content" style="width: 100%; height: 100%; overflow: auto;">
                <div style="text-align: center; padding-top: 50px; color: #888;">
                    <h2>Main View Canvas</h2>
                    <p>Select a file and click Load Graph</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Podaci iz Django View-a (prebačeni u JS objekat)
        const filesMap = {{ files_map|safe }}; 
        const currentGraphId = "{{ graph_id|default:'' }}"; //da li je django poslao id

        function updateFiles() {
            const pluginSelect = document.getElementById('plugin-select');
            const fileSelect = document.getElementById('file-select');
            const selectedPlugin = pluginSelect.value;

            // Resetujemo listu fajlova na default
            fileSelect.innerHTML = '<option value="">-- Select a file --</option>';

            // ako je izabran placeholder (prazan value), ne radimo nista dalje
            if (!selectedPlugin) return;

            const files = filesMap[selectedPlugin] || [];

            if (files.length === 0) {
                // mozda poruka da nema fajlova
            } else {
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.text = file.name;
                    fileSelect.add(option);
                });
            }
        }

        function changeVisualizer() {
            if (currentGraphId) {
                loadVisualization(currentGraphId);
            }
        }

        async function loadVisualization(graphId) {
            if (!graphId) return;
            const visSelect = document.getElementById('visualizer-select');
            const selectedVis = visSelect.value;

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<p style="text-align:center; margin-top:20px;">Loading visualization...</p>';

            try {
                const encodedId = encodeURIComponent(graphId); 
                const response = await fetch(`/api/visualize/${encodedId}/?visualizer=${selectedVis}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const htmlData = await response.text();
                
                // 1. Ubacimo HTML
                mainContent.innerHTML = htmlData;

                // 2. RUČNO IZVRŠAVANJE SKRIPTI
                // Browser ne izvrsava <script> tagove ubacene preko innerHTML.
                // Moramo ih naci i rucno pokrenuti.
                const scripts = mainContent.querySelectorAll("script");
                scripts.forEach(oldScript => {
                    const newScript = document.createElement("script");
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

            } catch (error) {
                console.error("Visualization error:", error);
                mainContent.innerHTML = `<p style="color:red; text-align:center;">Error loading visualization: ${error.message}</p>`;
            }
        }

        // Inicijalni poziv da se popuni lista za prvi selektovani plugin
        document.addEventListener('DOMContentLoaded', () => {
            
            // Ako imamo učitan graf, prikaži ga odmah
            if (currentGraphId) {
                loadVisualization(currentGraphId);
            }
        });
    </script>
</body>
</html>